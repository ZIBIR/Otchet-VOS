<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–û—Ç—á–µ—Ç –í–û–°</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background: #fff; margin: 0; padding: 20px; color: #000; }
        .header-block { text-align: center; margin-bottom: 20px; position: sticky; top: 0; background: #fff; padding-bottom: 15px; z-index: 10; border-bottom: 1px solid #eee;}
        h2 { margin: 10px 0; font-size: 20px; }
        input[type="date"] { font-size: 18px; padding: 12px; border: 2px solid #ddd; border-radius: 12px; background: #f9f9f9; width: 100%; box-sizing: border-box; text-align: center;}
        .page { display: none; animation: fadeIn 0.3s; padding-bottom: 80px;}
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .item-row { display: flex; align-items: center; margin-bottom: 12px; justify-content: space-between; }
        .item-btn { flex-grow: 1; background: #f2f2f5; color: #000; border: none; padding: 16px; border-radius: 14px; font-size: 16px; font-weight: 600; text-align: left; cursor: pointer; transition: 0.2s; }
        .item-btn.active { background: #3390ec; color: white; }
        .qty-input { width: 0; opacity: 0; padding: 0; margin: 0; border: none; transition: 0.3s;  border-bottom: 2px solid #3390ec; font-size: 20px; text-align: center; font-weight: bold; border-radius: 0; outline: none; background: transparent;}
        .item-row.active .qty-input { width: 60px; opacity: 1; margin-left: 10px; padding: 5px; }
        .nav-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .btn { flex: 1; padding: 16px; border: none; border-radius: 14px; font-size: 17px; font-weight: bold; cursor: pointer; }
        .btn-next { background: #3390ec; color: white; }
        .btn-back { background: #eef1f4; color: #000; }
        .btn-send { background: #34b759; color: white; }
        .btn-metal { background: #ffcc00; color: #000; margin-bottom: 10px; }
        #loading, #success-screen, #error-screen { display: none; text-align: center; margin-top: 50px; }
        .icon-lg { font-size: 60px; margin-bottom: 20px; }
    </style>
</head>
<body>

<div id="app">
    <div class="header-block">
        <input type="date" id="report-date">
    </div>

    <!-- 1. –ü–†–ò–®–õ–û -->
    <div id="page-1" class="page active">
        <h2>üì• –ü—Ä–∏—à–ª–æ –≤ —Ä–µ–º–æ–Ω—Ç</h2>
        <div id="list-page-1"></div>
        <div class="nav-buttons">
            <button class="btn btn-next" onclick="goToPage(2)">–î–∞–ª–µ–µ</button>
        </div>
    </div>

    <!-- 2. –í–´–î–ê–ù–û -->
    <div id="page-2" class="page">
        <h2>üì§ –í—ã–¥–∞–Ω–æ</h2>
        <div id="list-page-2"></div>
        <div class="nav-buttons">
            <button class="btn btn-back" onclick="goToPage(1)">–ù–∞–∑–∞–¥</button>
            <button class="btn btn-next" onclick="goToPage(3)">–î–∞–ª–µ–µ</button>
        </div>
    </div>

    <!-- 3. –ú–ï–ù–Æ -->
    <div id="page-3" class="page">
        <h2>üèÅ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ</h2>
        <div class="nav-buttons" style="flex-direction: column;">
            <button class="btn btn-metal" onclick="goToPage(4)">üîß –î–æ–±–∞–≤–∏—Ç—å —Å–ª–µ—Å–∞—Ä–∫—É</button>
            <button class="btn btn-send" onclick="sendData()">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç</button>
            <button class="btn btn-back" style="margin-top: 10px;" onclick="goToPage(2)">–ù–∞–∑–∞–¥</button>
        </div>
    </div>

    <!-- 4. –°–õ–ï–°–ê–†–ö–ê -->
    <div id="page-4" class="page">
        <h2>üîß –°–ª–µ—Å–∞—Ä–∫–∞ (–®–∏–Ω—ã)</h2>
        <div id="list-page-4"></div>
        <div class="nav-buttons">
            <button class="btn btn-back" onclick="goToPage(3)">–ì–æ—Ç–æ–≤–æ</button>
        </div>
    </div>
</div>

<div id="loading"><div class="icon-lg">‚è≥</div><h2>–û—Ç–ø—Ä–∞–≤–∫–∞...</h2></div>

<div id="success-screen">
    <div class="icon-lg">‚úÖ</div>
    <h2>–ì–æ—Ç–æ–≤–æ!</h2>
    <p>–î–∞–Ω–Ω—ã–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ —Ç–∞–±–ª–∏—Ü—É.</p>
    <button class="btn btn-back" onclick="Telegram.WebApp.close()">–ó–∞–∫—Ä—ã—Ç—å</button>
</div>

<div id="error-screen">
    <div class="icon-lg">‚ùå</div>
    <h2>–û—à–∏–±–∫–∞</h2>
    <p id="error-text">–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ.</p>
    <button class="btn btn-back" onclick="location.reload()">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand(); 

    // !!! –í–ê–ñ–ù–û: –í–°–¢–ê–í–¨–¢–ï –°–Æ–î–ê –ù–û–í–£–Æ –°–°–´–õ–ö–£ –ü–û–°–õ–ï –î–ï–ü–õ–û–Ø (NEW VERSION) !!!
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwTx1AjbFRS0OekI7IgL4jM5MI324-JWbxO2gP-yVE59dpixAAWBWUZyr0W86MaUIgE/exec"; 

    // –î–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–ª–µ–π
    const CONFIG = {
        1: [
            { key: "in_controller", label: "–ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä" },
            { key: "in_tracker", label: "–¢—Ä–µ–∫–µ—Ä" },
            { key: "in_motor", label: "–ú–æ—Ç–æ—Ä-–∫–æ–ª–µ—Å–æ" }
        ],
        2: [
            { key: "out_controller", label: "–ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä" },
            { key: "out_tracker", label: "–¢—Ä–µ–∫–µ—Ä" },
            { key: "out_motor", label: "–ú–æ—Ç–æ—Ä-–∫–æ–ª–µ—Å–æ" }
        ],
        4: [
            { key: "tires_out", label: "–í—ã–¥–∞–Ω–æ —à–∏–Ω" },
            { key: "tires_left", label: "–û—Å—Ç–∞–ª–æ—Å—å —à–∏–Ω" }
        ]
    };

    // –°—Ç–∞—Ä—Ç
    const dateInput = document.getElementById('report-date');
    dateInput.valueAsDate = new Date(); // –°–µ–≥–æ–¥–Ω—è—à–Ω—è—è –¥–∞—Ç–∞

    function renderItems(pId) {
        const c = document.getElementById(`list-page-${pId}`);
        CONFIG[pId].forEach(item => {
            const row = document.createElement('div');
            row.className = 'item-row';
            row.id = `row-${item.key}`;
            
            row.innerHTML = `
                <button class="item-btn" onclick="toggleItem('${item.key}')">${item.label}</button>
                <input type="number" id="input-${item.key}" class="qty-input" placeholder="#" min="1" enterkeyhint="done">
            `;
            c.appendChild(row);

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ–∫—É—Å–∞
            const inp = row.querySelector('input');
            inp.addEventListener('blur', () => { if(!inp.value) toggleItem(item.key); });
        });
    }

    // –†–µ–Ω–¥–µ—Ä–∏–º –≤—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    [1, 2, 4].forEach(renderItems);

    function toggleItem(key) {
        const row = document.getElementById(`row-${key}`);
        const btn = row.querySelector('.item-btn');
        const input = document.getElementById(`input-${key}`);
        const isActive = row.classList.contains('active');

        if (isActive) {
            row.classList.remove('active');
            btn.classList.remove('active');
            input.value = "";
        } else {
            row.classList.add('active');
            btn.classList.add('active');
            input.value = "1";
            input.focus();
        }
        if(tg.HapticFeedback) tg.HapticFeedback.selectionChanged();
    }

    function goToPage(n) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(`page-${n}`).classList.add('active');
        window.scrollTo(0,0);
        if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
    }

    function sendData() {
        const rawDate = dateInput.value;
        if (!rawDate) { alert("–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É!"); return; }

        const [y, m, d] = rawDate.split('-');
        const fDate = `${d}.${m}.${y}`;
        
        const data = {};
        [1, 2, 4].forEach(p => {
            CONFIG[p].forEach(i => {
                const val = document.getElementById(`input-${i.key}`).value;
                if (val) data[i.key] = parseInt(val);
            });
        });

        const user = tg.initDataUnsafe.user || { first_name: "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π", id: 0 };
        let uName = user.first_name;
        if (user.last_name) uName += " " + user.last_name;
        if (user.username) uName += " (@" + user.username + ")";

        const payload = {
            date: fDate,
            items: data,
            username: uName
        };

        document.getElementById('app').style.display = 'none';
        document.getElementById('loading').style.display = 'block';

        // –û—Ç–ø—Ä–∞–≤–∫–∞
        fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors', // –í–∞–∂–Ω–æ –¥–ª—è GAS
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        }).then(() => {
            // –í —Ä–µ–∂–∏–º–µ no-cors –º—ã –≤—Å–µ–≥–¥–∞ –ø–æ–ø–∞–¥–∞–µ–º —Å—é–¥–∞, –¥–∞–∂–µ –µ—Å–ª–∏ —Å–∫—Ä–∏–ø—Ç —É–ø–∞–ª.
            // –ù–æ –º—ã –¥–æ–±–∞–≤–∏–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –≤–Ω—É—Ç—Ä–∏ –±–æ—Ç–∞ (–æ–Ω –Ω–∞–ø–∏—à–µ—Ç –µ—Å–ª–∏ —á—Ç–æ –Ω–µ —Ç–∞–∫)
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('success-screen').style.display = 'block';
                if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
            }, 1000); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã
        }).catch(err => {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error-screen').style.display = 'block';
            document.getElementById('error-text').innerText = err;
        });
    }
</script>

</body>
</html>
